using Mjml.Net.Properties;

namespace Mjml.Net.Components;

public sealed class RootComponent : Component
{
    private static readonly string DefaultMeta = Resources.DefaultMeta;
    private static readonly string DefaultStyles = Resources.DefaultStyles;
    private static readonly string DefaultComments = Resources.DefaultComments;

    public override string ComponentName => "mjml";

    public override void Render(IHtmlRenderer renderer, GlobalContext context)
    {
        RenderChildren(renderer, context);

        if (Parent != null)
        {
            return;
        }

        renderer.Content("<!doctype html>");
        renderer.Content("<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">");
        renderer.Content(string.Empty);

        RenderHead(renderer, context);

        renderer.Content(string.Empty);

        RenderBody(renderer, context);

        renderer.Content(string.Empty);
        renderer.Content("</html>");
    }

    private static void RenderHead(IHtmlRenderer renderer, GlobalContext context)
    {
        renderer.StartElement("head");

        renderer.RenderHelpers(HelperTarget.HeadStart);

        // Add default meta tags.
        renderer.Content(DefaultMeta);

        renderer.StartElement("style").Attr("type", "text/css");
        renderer.Content(DefaultStyles);
        renderer.EndElement("style");

        renderer.Content(DefaultComments);

        foreach (var (_, value) in context.GlobalData)
        {
            if (value is HeadBuffer head && head.Buffer != null)
            {
                // Already formatted properly.
                renderer.Plain(head.Buffer);
                renderer.ReturnStringBuilder(head.Buffer);
            }
        }

        renderer.RenderHelpers(HelperTarget.HeadEnd);

        renderer.EndElement("head");
    }

    private static void RenderBody(IHtmlRenderer renderer, GlobalContext context)
    {
        renderer.StartElement("body")
            .Style("background-color", context.GlobalData.Values.OfType<Background>().FirstOrDefault()?.Color)
            .Style("word-spacing", "normal");

        renderer.RenderHelpers(HelperTarget.BodyStart);

        foreach (var (_, value) in context.GlobalData)
        {
            if (value is BodyBuffer body && body.Buffer != null)
            {
                // Already formatted properly.
                renderer.Plain(body.Buffer);
                renderer.ReturnStringBuilder(body.Buffer);
            }
        }

        renderer.RenderHelpers(HelperTarget.BodyEnd);

        renderer.EndElement("body");
    }
}
